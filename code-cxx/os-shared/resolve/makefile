# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make clean  - removes all files generated by make.

TARGET1 = first
TARGET2 = preload
TARGET3 = name
TARGET4 = order
TARGET5 = intercept

# Where to find user code.
USER_DIR = .

CPPFLAGS += -isystem $(GTEST_DIR)/include -isystem $(GMOCK_DIR)/include 

# CXXFLAGS += -std=c++11 -g -Wall -Wextra -pthread -D_GLIBCXX_DEBUG
CXXFLAGS += -std=c++11 -g -Wall -Wextra -pthread -D_GLIBCXX_DEBUG

TESTS = $(TARGET1)_out \
				$(TARGET2)_out \
				$(TARGET3)_out \
				$(TARGET4)_out \
				$(TARGET5)_out

# target
$(TARGET5) :$(TARGET5)_out


# House-keeping build targets.
all : $(TESTS)

clean :
	rm -f $(TESTS) *.a *.o *.so

#
$(TARGET1)_so.o : $(TARGET1)_so.c
	gcc -g -fpic -c $(TARGET1)_so.c -o $(TARGET1)_so.o
	gcc -g -std=c99 -shared $(TARGET1)_so.o -o lib$(TARGET1).so

$(TARGET1)_out : $(TARGET1)_so.o $(TARGET1)_main.c
	gcc -g -std=c99 $(TARGET1)_main.c lib$(TARGET1).so -o $@

#
$(TARGET2)_so.o : $(TARGET2)_so.c
	gcc -g -fpic -c $(TARGET2)_so.c -o $(TARGET2)_so.o
	gcc -g -std=c99 -shared $(TARGET2)_so.o -o lib$(TARGET2).so

$(TARGET2)_out : $(TARGET2)_so.o $(TARGET2)_main.c
	gcc -g -std=c99 $(TARGET2)_main.c lib$(TARGET2).so -o $@

#
$(TARGET3)_so.o : $(TARGET3)_so.c
	gcc -g -fpic -c $(TARGET3)_so.c -o $(TARGET3)_so.o
	gcc -g -std=c99 -shared $(TARGET3)_so.o -o lib$(TARGET3).so

$(TARGET3)_out : $(TARGET3)_so.o $(TARGET3)_main.c
	gcc -g -std=c99 $(TARGET3)_main.c lib$(TARGET3).so -o $@

#
$(TARGET4)_so_1.o $(TARGET4)_so_2.o $(TARGET4)_so_3.so : \
	$(TARGET4)_so_1.c $(TARGET4)_so_2.c $(TARGET4)_so_3.c
	gcc -g -fpic -c $(TARGET4)_so_1.c -o $(TARGET4)_so_1.o
	gcc -g -std=c99 -shared $(TARGET4)_so_1.o -o lib$(TARGET4)_1.so
	gcc -g -fpic -c $(TARGET4)_so_2.c -o $(TARGET4)_so_2.o
	gcc -g -std=c99 -shared $(TARGET4)_so_2.o -o lib$(TARGET4)_2.so
	gcc -g -fpic -c $(TARGET4)_so_3.c -o $(TARGET4)_so_3.o
	gcc -g -std=c99 -shared $(TARGET4)_so_3.o -o lib$(TARGET4)_3.so

$(TARGET4)_out : $(TARGET4)_so_1.o $(TARGET4)_so_2.o $(TARGET4)_so_3.o $(TARGET4)_main.c
	# gcc -g -std=c99 $(TARGET4)_main.c lib$(TARGET4)_1.so lib$(TARGET4)_2.so lib$(TARGET4)_3.so -o $@
	gcc -g -std=c99 $(TARGET4)_main.c lib$(TARGET4)_1.so lib$(TARGET4)_2.so lib$(TARGET4)_3.so -o $(TARGET4)_123_out
	gcc -g -std=c99 $(TARGET4)_main.c lib$(TARGET4)_3.so lib$(TARGET4)_1.so lib$(TARGET4)_2.so -o $(TARGET4)_321_out
	gcc -g -std=c99 $(TARGET4)_main.c lib$(TARGET4)_2.so lib$(TARGET4)_3.so lib$(TARGET4)_1.so -o $(TARGET4)_231_out

#
$(TARGET5)_so.o : $(TARGET5)_so.c
	g++ -g -fpic -c $(TARGET5)_so.c -o $(TARGET5)_so.o
	g++ -g -shared $(TARGET5)_so.o -o lib$(TARGET5).so

$(TARGET5)_out : $(TARGET5)_so.o $(TARGET5)_main.c
	g++ -g $(TARGET5)_main.c lib$(TARGET5).so -ldl -o $@
